#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
set -euo pipefail

# =============================================================================
# run_once: Install dev tools (runs once per machine via chezmoi)
# This script is executed by `chezmoi apply` on first setup.
# To re-run: chezmoi state delete-bucket --bucket=scriptState
# =============================================================================

GREEN='\033[0;32m'; YELLOW='\033[1;33m'; NC='\033[0m'
info() { echo -e "${GREEN}[✓]${NC} $*"; }
warn() { echo -e "${YELLOW}[→]${NC} $*"; }

# {{ if eq .chezmoi.os "darwin" }}
command -v brew &>/dev/null || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

brew install --quiet tmux neovim lazygit go node ripgrep fd fzf git-delta age gitleaks pre-commit 2>/dev/null
brew install --cask font-jetbrains-mono-nerd-font 2>/dev/null || true
info "Homebrew packages + Nerd Font installed"
# {{ else if eq .chezmoi.os "linux" }}
sudo apt-get update -qq
sudo apt-get install -y -qq tmux git curl unzip ripgrep fzf

# Neovim
if ! command -v nvim &>/dev/null; then
    curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz
    sudo rm -rf /opt/nvim && sudo tar -C /opt -xzf nvim-linux-x86_64.tar.gz
    sudo ln -sf /opt/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim
    rm -f nvim-linux-x86_64.tar.gz
fi

# fd
if ! command -v fd &>/dev/null; then
    sudo apt-get install -y -qq fd-find
    sudo ln -sf "$(command -v fdfind)" /usr/local/bin/fd 2>/dev/null || true
fi

# lazygit
if ! command -v lazygit &>/dev/null; then
    LG_VER=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -Lo /tmp/lg.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LG_VER}_Linux_x86_64.tar.gz"
    tar xf /tmp/lg.tar.gz -C /tmp lazygit && sudo install /tmp/lazygit /usr/local/bin
fi

# Go
if ! command -v go &>/dev/null; then
    GO_VER=$(curl -s https://go.dev/VERSION?m=text | head -1)
    curl -LO "https://go.dev/dl/${GO_VER}.linux-amd64.tar.gz"
    sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf "${GO_VER}.linux-amd64.tar.gz"
    rm -f "${GO_VER}.linux-amd64.tar.gz"
fi

# Node.js
if ! command -v node &>/dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
    sudo apt-get install -y nodejs
fi

# delta
if ! command -v delta &>/dev/null; then
    D_VER=$(curl -s "https://api.github.com/repos/dandavison/delta/releases/latest" | grep -Po '"tag_name": "\K[^"]*')
    curl -Lo /tmp/delta.deb "https://github.com/dandavison/delta/releases/latest/download/git-delta_${D_VER}_amd64.deb"
    sudo dpkg -i /tmp/delta.deb || sudo apt-get -f install -y
fi

# Nerd Font (JetBrains Mono)
FONT_DIR="$HOME/.local/share/fonts"
if ! ls "$FONT_DIR"/JetBrainsMono*.ttf &>/dev/null 2>&1; then
    warn "Installing JetBrains Mono Nerd Font..."
    mkdir -p "$FONT_DIR"
    curl -fLo /tmp/JetBrainsMono.tar.xz "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.tar.xz"
    tar -xf /tmp/JetBrainsMono.tar.xz -C "$FONT_DIR"
    fc-cache -fv "$FONT_DIR" >/dev/null 2>&1
    rm -f /tmp/JetBrainsMono.tar.xz
fi

# age
command -v age &>/dev/null || sudo apt-get install -y -qq age

# gitleaks
if ! command -v gitleaks &>/dev/null; then
    GL_VER=$(curl -s "https://api.github.com/repos/gitleaks/gitleaks/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -Lo /tmp/gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_${GL_VER}_linux_x64.tar.gz"
    tar xf /tmp/gitleaks.tar.gz -C /tmp gitleaks && sudo install /tmp/gitleaks /usr/local/bin
    rm -f /tmp/gitleaks.tar.gz /tmp/gitleaks
fi

# pre-commit
command -v pre-commit &>/dev/null || pip3 install pre-commit
# {{ end }}

export PATH="$PATH:/usr/local/go/bin:$HOME/go/bin"

# Go tools
for tool in \
    "golang.org/x/tools/gopls@latest" \
    "github.com/golangci/golangci-lint/cmd/golangci-lint@latest" \
    "github.com/go-delve/delve/cmd/dlv@latest" \
    "golang.org/x/tools/cmd/goimports@latest" \
    "github.com/fatih/gomodifytags@latest" \
    "github.com/josharian/impl@latest" \
    "github.com/cweill/gotests/gotests@latest"
do
    name=$(basename "${tool%%@*}")
    command -v "$name" &>/dev/null || go install "$tool"
done
info "Go tools installed"

# Claude Code
command -v claude &>/dev/null || npm install -g @anthropic-ai/claude-code
info "Claude Code ready"

# TPM
TPM="$HOME/.tmux/plugins/tpm"
[[ -d "$TPM" ]] || git clone https://github.com/tmux-plugins/tpm "$TPM"
info "TPM ready"

# LazyVim starter (only if no config exists)
NV="$HOME/.config/nvim"
if [[ ! -f "$NV/lazyvim.json" ]] && [[ ! -f "$NV/lua/config/lazy.lua" ]]; then
    [[ -d "$NV" ]] && mv "$NV" "$NV.bak.$(date +%s)"
    git clone https://github.com/LazyVim/starter "$NV" && rm -rf "$NV/.git"
fi
info "LazyVim ready"

# Activate pre-commit hooks (if .pre-commit-config.yaml exists in chezmoi source)
CHEZMOI_SOURCE="$(chezmoi source-path 2>/dev/null || true)"
if [[ -n "$CHEZMOI_SOURCE" ]] && [[ -f "$CHEZMOI_SOURCE/../.pre-commit-config.yaml" ]]; then
    (cd "$CHEZMOI_SOURCE/.." && pre-commit install) && info "pre-commit hooks ✓"
fi

echo ""
info "All tools installed! Run 'tmux new -s dev' to start."
